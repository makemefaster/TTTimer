<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TT Timer V4 (Auto-Stop)</title>
    <style>
        :root {
            --orange: #ff9800; 
            --green: #4caf50; 
            --red: #f44336; 
            --dark: #212121;
            --text-on-dark: #ffffff;
            --text-on-card: #000000;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark);
            color: var(--text-on-dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: #333;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 100;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .master-clock {
            font-family: monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #81d4fa;
            background: #000;
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid #555;
            min-width: 120px;
            text-align: center;
        }
        
        /* Visual cue when clock stops */
        .clock-stopped {
            color: #ff5252; /* Red text when stopped */
            border-color: #ff5252;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-setup { background-color: #90caf9; color: #000; }
        .btn-export { background-color: #ce93d8; color: #000; }
        .btn-start-auto { background-color: var(--green); color: white; }
        .btn-stop-auto { background-color: var(--red); color: white; display: none; }

        /* AUTO START BAR */
        #interval-bar {
            background-color: #000;
            color: var(--orange);
            text-align: center;
            padding: 12px;
            font-size: 1.3rem;
            font-weight: bold;
            border-bottom: 2px solid #555;
            display: none;
            flex-shrink: 0;
        }

        /* RIDER LIST */
        #rider-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 80px;
        }

        /* RIDER CARD */
        .rider-card {
            display: grid;
            grid-template-columns: 80px 1fr 70px; 
            height: 120px;
            border-radius: 12px;
            color: var(--text-on-card);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .rider-card:active { transform: scale(0.98); }

        .state-waiting { background-color: var(--orange); }
        .state-racing { background-color: var(--green); }
        .state-finished { background-color: var(--red); color: white; }
        
        .card-number {
            font-size: 2.5rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.15);
        }

        .card-info {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; 
            padding: 5px 15px;
        }
        
        .card-name {
            font-size: 1.3rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-timer {
            font-family: monospace;
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .card-laps {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            font-weight: bold;
            border-left: 1px solid rgba(0,0,0,0.15);
        }
        .lap-label { font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }
        .lap-val { font-size: 2.2rem; line-height: 1; }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white; color: black; padding: 20px;
            border-radius: 10px; width: 90%; max-width: 400px;
        }
        textarea, input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; font-size: 1rem; }
        .row { display: flex; gap: 10px; }
        .row button { flex: 1; }

        /* EDIT OVERLAY */
        .edit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 50;
        }
        .edit-overlay h3 { margin: 0; color: white; font-size: 1.5rem; }

    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div style="font-weight:bold; font-size: 1.4rem;">CycleTT</div>
        <div id="master-clock" class="master-clock">00:00</div>
    </div>
    <div class="controls">
        <button class="btn-setup" onclick="openSetup()">‚öôÔ∏è Setup</button>
        <button id="btn-start-auto" class="btn-start-auto" onclick="startAutoSchedule()" style="display:none">‚ñ∂ Start Auto</button>
        <button id="btn-stop-auto" class="btn-stop-auto" onclick="stopAutoSchedule()">‚èπ Stop Auto</button>
        <button class="btn-export" onclick="exportData()">üìã Copy Results</button>
    </div>
</header>

<div id="interval-bar">
    Next: <span id="next-rider-name">...</span> <span id="next-countdown" style="margin-left:10px; color:#fff">00:00</span>
</div>

<div id="rider-list">
    <div style="text-align:center; padding: 60px; color: #888;">
        <h2>Ready to Race</h2>
        <p>Tap "Setup" to add riders.</p>
    </div>
</div>

<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h2>Race Setup</h2>
        <label>Riders (Paste: Number Name)</label>
        <textarea id="input-riders" rows="6" placeholder="101 John Doe&#10;102 Jane Smith"></textarea>
        
        <label>Total Laps</label>
        <input type="number" id="input-laps" value="3">

        <label>Start Interval (Seconds)</label>
        <input type="number" id="input-interval" value="30">

        <div class="row">
            <button onclick="closeSetup()" style="background:#ccc">Cancel</button>
            <button onclick="saveSetup()" style="background:var(--green); color:white">Create Race</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let riders = [];
    let totalLaps = 3;
    let intervalSeconds = 30;
    
    let raceStartTime = null; 
    let autoIntervalActive = false;
    let nextAutoStartTime = null; 
    let uiTimerId = null;

    function openSetup() { document.getElementById('setup-modal').style.display = 'flex'; }
    function closeSetup() { document.getElementById('setup-modal').style.display = 'none'; }

    function saveSetup() {
        const text = document.getElementById('input-riders').value;
        if (!text.trim()) return;

        totalLaps = parseInt(document.getElementById('input-laps').value);
        intervalSeconds = parseInt(document.getElementById('input-interval').value);
        
        riders = [];
        raceStartTime = null;
        autoIntervalActive = false;
        
        const lines = text.split('\n');
        lines.forEach((line, index) => {
            if (line.trim()) {
                const parts = line.trim().split(/\s+(.*)/);
                riders.push({
                    id: Date.now() + index,
                    number: parts[0] || (index + 1),
                    name: parts[1] || `Rider ${parts[0]}`,
                    status: 'waiting',
                    lapsRemaining: totalLaps,
                    startTime: null,
                    splits: [],
                    lastLapStart: null,
                    originalIndex: index
                });
            }
        });

        renderRiders();
        closeSetup();
        
        const btn = document.getElementById('btn-start-auto');
        btn.style.display = 'block';
        btn.innerText = `‚ñ∂ Start Auto (${intervalSeconds}s)`;
        
        // Reset Clock Display
        const clock = document.getElementById('master-clock');
        clock.innerText = "00:00";
        clock.classList.remove('clock-stopped');

        if(uiTimerId) clearInterval(uiTimerId);
        uiTimerId = setInterval(updateUI, 100);
    }

    let pressTimer;
    function cardDown(id) { pressTimer = setTimeout(() => showEditMenu(id), 600); }
    function cardUp(id) { clearTimeout(pressTimer); }
    function cardClick(id) {
        if (document.getElementById(`edit-${id}`).style.display === 'flex') return;
        const rider = riders.find(r => r.id === id);
        if (!rider) return;

        if (rider.status === 'waiting') startRider(rider);
        else if (rider.status === 'racing') recordSplit(rider);
    }

    function startRider(rider) {
        const now = Date.now();
        if (!raceStartTime) raceStartTime = now; 
        rider.status = 'racing';
        rider.startTime = now;
        rider.lastLapStart = now;

        if (autoIntervalActive) {
            nextAutoStartTime = now + (intervalSeconds * 1000);
        }
        renderRiders();
    }

    function recordSplit(rider) {
        const now = Date.now();
        rider.splits.push(now - rider.lastLapStart);
        rider.lapsRemaining--;
        rider.lastLapStart = now;
        if (rider.lapsRemaining <= 0) rider.status = 'finished';
        renderRiders();
    }

    function startAutoSchedule() {
        autoIntervalActive = true;
        document.getElementById('btn-start-auto').style.display = 'none';
        document.getElementById('btn-stop-auto').style.display = 'block';
        document.getElementById('interval-bar').style.display = 'block';

        const nextRider = getNextWaitingRider();
        if (nextRider) {
             if (!raceStartTime) startRider(nextRider);
             else if (!nextAutoStartTime) nextAutoStartTime = Date.now() + (intervalSeconds * 1000);
        }
    }

    function stopAutoSchedule() {
        autoIntervalActive = false;
        document.getElementById('btn-start-auto').style.display = 'block';
        document.getElementById('btn-stop-auto').style.display = 'none';
        document.getElementById('interval-bar').style.display = 'none';
    }

    function getNextWaitingRider() {
        return riders.filter(r => r.status === 'waiting')
                     .sort((a,b) => a.originalIndex - b.originalIndex)[0];
    }

    function updateUI() {
        const now = Date.now();

        // --- MASTER CLOCK LOGIC (With Stop) ---
        const clockEl = document.getElementById('master-clock');
        if (raceStartTime) {
            const allFinished = riders.length > 0 && riders.every(r => r.status === 'finished');
            
            if (allFinished) {
                // Find the timestamp when the LAST rider finished
                let maxFinishTimestamp = 0;
                riders.forEach(r => {
                    // Start Time + Sum of all splits = Finish Timestamp
                    const finishTime = r.startTime + r.splits.reduce((a,b)=>a+b, 0);
                    if(finishTime > maxFinishTimestamp) maxFinishTimestamp = finishTime;
                });
                clockEl.innerText = formatMinSec(maxFinishTimestamp - raceStartTime);
                clockEl.classList.add('clock-stopped');
            } else {
                clockEl.innerText = formatMinSec(now - raceStartTime);
                clockEl.classList.remove('clock-stopped');
            }
        }

        // --- AUTO START ---
        if (autoIntervalActive) {
            if (nextAutoStartTime && now >= nextAutoStartTime) {
                const next = getNextWaitingRider();
                if (next) startRider(next);
                else stopAutoSchedule();
            }
            const nextRider = getNextWaitingRider();
            if (nextRider) {
                const diff = Math.max(0, nextAutoStartTime - now);
                document.getElementById('next-rider-name').innerText = `#${nextRider.number}`;
                document.getElementById('next-countdown').innerText = (diff/1000).toFixed(1) + "s";
            } else {
                document.getElementById('interval-bar').innerText = "All riders started";
            }
        }

        // --- INDIVIDUAL TIMERS ---
        riders.forEach(r => {
            const el = document.getElementById(`timer-${r.id}`);
            if (!el) return;
            if (r.status === 'racing') {
                el.innerText = formatMinSec(now - r.startTime);
            } else if (r.status === 'finished') {
                const total = r.splits.reduce((a,b)=>a+b, 0);
                el.innerText = formatMinSec(total);
            }
        });

        // --- SORT ---
        riders.sort((a, b) => {
            if (a.status === 'racing' && b.status === 'racing') return a.lastLapStart - b.lastLapStart; 
            const s = { 'racing': 1, 'waiting': 2, 'finished': 3 };
            if (s[a.status] !== s[b.status]) return s[a.status] - s[b.status];
            return a.originalIndex - b.originalIndex;
        });
        
        const list = document.getElementById('rider-list');
        riders.forEach(r => {
            const card = document.getElementById(`card-${r.id}`);
            if (card) list.appendChild(card);
        });
    }

    function formatMinSec(ms) {
        const totalSec = Math.floor(ms / 1000);
        const m = Math.floor(totalSec / 60);
        const s = totalSec % 60;
        return `${m}:${s.toString().padStart(2,'0')}`;
    }

    function renderRiders() {
        const list = document.getElementById('rider-list');
        list.innerHTML = '';
        
        riders.forEach(r => {
            const div = document.createElement('div');
            div.id = `card-${r.id}`;
            div.className = `rider-card state-${r.status}`;
            div.onmousedown = () => cardDown(r.id);
            div.ontouchstart = () => cardDown(r.id);
            div.onmouseup = () => { cardUp(r.id); cardClick(r.id); };
            div.ontouchend = (e) => { e.preventDefault(); cardUp(r.id); cardClick(r.id); };

            div.innerHTML = `
                <div class="card-number">${r.number}</div>
                <div class="card-info">
                    <div class="card-name">${r.name}</div>
                    <div class="card-timer" id="timer-${r.id}">00:00</div>
                </div>
                <div class="card-laps">
                    <span class="lap-label">Laps</span>
                    <span class="lap-val">${r.lapsRemaining}</span>
                </div>
                <div id="edit-${r.id}" class="edit-overlay" onclick="event.stopPropagation()">
                    <h3>#${r.number}</h3>
                    <button style="background:var(--orange); color:black" onclick="undo(${r.id})">‚Ü© Undo Last</button>
                    <button style="background:#ccc" onclick="hideEditMenu(${r.id})">Cancel</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function showEditMenu(id) { document.getElementById(`edit-${id}`).style.display = 'flex'; }
    function hideEditMenu(id) { document.getElementById(`edit-${id}`).style.display = 'none'; }
    
    function undo(id) {
        const r = riders.find(x => x.id === id);
        if (r.status === 'finished') {
            r.status = 'racing'; r.lapsRemaining = 1; r.splits.pop();
        } else if (r.status === 'racing') {
            if (r.splits.length > 0) { r.splits.pop(); r.lapsRemaining++; }
            else { r.status = 'waiting'; r.startTime = null; }
        }
        hideEditMenu(id); renderRiders();
    }

    function exportData() {
        let out = "Number\tName\t";
        for(let i=1; i<=totalLaps; i++) out += `Lap ${i}\t`;
        out += "Total\n";
        [...riders].sort((a,b)=>a.originalIndex-b.originalIndex).forEach(r => {
            out += `${r.number}\t${r.name}\t`;
            let t = 0;
            r.splits.forEach(s => { out += formatMinSec(s)+"\t"; t+=s; });
            for(let i=r.splits.length; i<totalLaps; i++) out += "-\t";
            out += (r.splits.length > 0 ? formatMinSec(t) : "-") + "\n";
        });
        navigator.clipboard.writeText(out).then(()=>alert("Copied!"));
    }
</script>
</body>
</html>
